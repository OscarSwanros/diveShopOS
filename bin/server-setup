#!/usr/bin/env bash
# Server provisioning script for DiveShopOS on Ubuntu 24.04 (Vultr)
# Usage: ssh root@<IP> 'bash -s' < bin/server-setup
set -euo pipefail

echo "==> DiveShopOS server setup starting..."

# Update system packages
apt-get update -qq && apt-get upgrade -y -qq

# Install Docker
curl -fsSL https://get.docker.com | sh

# Create deploy user with Docker group access
if ! id deploy &>/dev/null; then
  adduser --disabled-password --gecos "" deploy
fi
usermod -aG docker deploy

# Copy SSH keys from root to deploy user
mkdir -p /home/deploy/.ssh
cp /root/.ssh/authorized_keys /home/deploy/.ssh/authorized_keys
chown -R deploy:deploy /home/deploy/.ssh
chmod 700 /home/deploy/.ssh
chmod 600 /home/deploy/.ssh/authorized_keys

# Harden SSH
sed -i 's/^#\?PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config
sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication no/' /etc/ssh/sshd_config
systemctl restart sshd

# Configure UFW firewall
ufw allow OpenSSH
ufw allow 80/tcp
ufw allow 443/tcp
ufw --force enable

# Set up 2GB swap
if [ ! -f /swapfile ]; then
  fallocate -l 2G /swapfile
  chmod 600 /swapfile
  mkswap /swapfile
  swapon /swapfile
  echo '/swapfile none swap sw 0 0' >> /etc/fstab
  echo "vm.swappiness=10" >> /etc/sysctl.conf
  sysctl -p
fi

# Set timezone to UTC
timedatectl set-timezone UTC

echo "==> Server setup complete."
echo "==> SSH as 'deploy' user is ready. Root login is now disabled."
echo "==> Next: run 'bin/kamal setup -d <destination>' from your local machine."
