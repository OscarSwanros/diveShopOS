#!/usr/bin/env bash
# Database backup script for DiveShopOS
# Usage: bin/backup-db production   -- backup production database
#        bin/backup-db staging      -- backup staging database
#
# Restore: pg_restore -h localhost -U diveshopos -d vamosabucear_production backup_file.dump
#   or:    psql -h localhost -U diveshopos -d vamosabucear_production < backup_file.sql
set -euo pipefail

DESTINATION="${1:-}"

if [ -z "$DESTINATION" ]; then
  echo "Usage: bin/backup-db <staging|production>"
  exit 1
fi

if [ "$DESTINATION" != "staging" ] && [ "$DESTINATION" != "production" ]; then
  echo "Error: destination must be 'staging' or 'production'"
  exit 1
fi

TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="tmp/backups"
BACKUP_FILE="${BACKUP_DIR}/vamosabucear_${DESTINATION}_${TIMESTAMP}.sql"

mkdir -p "$BACKUP_DIR"

# Get the server IP from the Kamal destination config
SERVER_IP=$(bin/kamal details -d "$DESTINATION" 2>/dev/null | grep -oP '\d+\.\d+\.\d+\.\d+' | head -1)

if [ -z "$SERVER_IP" ]; then
  echo "Error: could not determine server IP for $DESTINATION"
  exit 1
fi

DB_NAME="vamosabucear_${DESTINATION}"

echo "==> Backing up $DB_NAME from $DESTINATION ($SERVER_IP)..."

ssh deploy@"$SERVER_IP" \
  "docker exec vamosabucear-db pg_dump -U diveshopos -d $DB_NAME" \
  > "$BACKUP_FILE"

FILESIZE=$(wc -c < "$BACKUP_FILE" | tr -d ' ')
echo "==> Backup saved to $BACKUP_FILE ($FILESIZE bytes)"
echo ""
echo "To restore:"
echo "  psql -h <host> -U diveshopos -d $DB_NAME < $BACKUP_FILE"
